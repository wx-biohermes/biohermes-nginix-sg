# ============================================================================
# 通用SSL安全设置配置文件
# 创建日期: 2025-11-08
# 最后修改: 2025-11-08
# 用途: 提供全面的SSL/TLS安全配置，适用于所有HTTPS站点
# 注意事项: 此文件仅应在server块中包含，不要在http块中全局包含
# 适用范围: 所有启用HTTPS的Nginx服务器配置
# ============================================================================

# ============================================================================
# 一、SSL/TLS协议版本配置
# 控制使用哪些SSL/TLS协议版本，确保安全性
# ============================================================================

# ---------------------------------------------------------------------------
# SSL协议版本控制
# ---------------------------------------------------------------------------
# 仅启用安全的TLS 1.2和TLS 1.3协议
# 安全考虑:
# - TLS 1.2: 目前广泛使用的安全协议，提供强加密保护
# - TLS 1.3: 最新的协议版本，提供更好的安全性和性能
# - 已禁用不安全的版本: SSLv2、SSLv3、TLSv1.0和TLSv1.1已被证明存在安全漏洞
# 兼容性影响: 可能不支持非常旧的浏览器(2014年之前的版本)
# 安全最佳实践: 仅使用现代安全协议版本
# 注意：ssl_protocols已在server块中通过listen指令设置
# 如需要自定义协议版本，请修改server块中的listen指令
# ssl_protocols TLSv1.2 TLSv1.3;

# ============================================================================
# 二、加密套件配置
# 选择安全的加密算法组合，确保数据传输的保密性和完整性
# ============================================================================

# ---------------------------------------------------------------------------
# 加密套件优先级控制
# ---------------------------------------------------------------------------
# 优先使用服务器定义的加密套件顺序，而不是客户端的偏好
# 安全意义: 允许服务器强制执行更安全的加密套件选择
# 工作原理: 当客户端支持多个加密套件时，使用服务器指定的优先顺序
# 最佳实践: 始终启用，确保最安全的加密套件被优先使用
ssl_prefer_server_ciphers on;

# ---------------------------------------------------------------------------
# 加密套件选择
# ---------------------------------------------------------------------------
# 配置安全的加密套件列表
# 技术说明:
# - ECDHE: 使用椭圆曲线Diffie-Hellman临时密钥交换，提供前向安全性
# - RSA/ECDSA: 密钥交换算法，ECDSA在相同安全性下提供更好的性能
# - AES/GCM: 对称加密算法，提供强加密和数据完整性校验
# - CHACHA20-POLY1305: 现代高效加密算法，特别适合移动设备和低功耗环境
# 安全特性: 所有套件都提供前向安全性，即使私钥泄露，过去的通信仍受保护
# 性能考量: 套件列表按性能和安全性平衡排序，优先选择高效套件
# 注意: 此列表针对TLS 1.2进行了优化，TLS 1.3有自己内置的加密套件选择逻辑
ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;

# ============================================================================
# 三、SSL会话管理
# 优化SSL会话处理，平衡安全性和性能
# ============================================================================

# ---------------------------------------------------------------------------
# SSL会话超时设置
# ---------------------------------------------------------------------------
# 设置SSL会话缓存的过期时间
# 1d: 会话在缓存中保留1天
# 安全影响: 较短的超时提高安全性，但增加握手次数；较长的超时提高性能
# 最佳平衡: 1天是安全性和性能的良好折衷，适合大多数网站
ssl_session_timeout 1d;

# ---------------------------------------------------------------------------
# SSL会话缓存配置
# ---------------------------------------------------------------------------
# 配置共享的SSL会话缓存
# shared:SSL:10m: 创建名为SSL的共享缓存区域，分配10MB内存
# 工作原理: 缓存SSL会话参数，允许客户端重用之前协商的会话，减少握手开销
# 性能影响: 启用缓存可以显著提高性能，特别是对于频繁访问的网站
# 内存消耗: 10MB缓存可存储约40,000个会话，适合中等流量网站
# 注意: 在高流量服务器上，可能需要增加缓存大小
ssl_session_cache shared:SSL:10m;

# ---------------------------------------------------------------------------
# 禁用SSL会话票据
# ---------------------------------------------------------------------------
# 禁用SSL会话票据功能
# 安全考虑: 会话票据可能带来安全风险，因为:
# 1. 默认情况下，Nginx使用静态密钥加密会话票据
# 2. 如果密钥泄露，攻击者可以解密之前的会话
# 3. 在无法安全轮换密钥的环境中，禁用是更安全的选择
# 性能影响: 禁用会话票据会略微增加握手开销，但提高了安全性
# 注意: 如果Nginx版本支持安全的密钥轮换，可以考虑启用此功能
ssl_session_tickets off;

# ============================================================================
# 四、椭圆曲线配置
# 为ECDHE密钥交换选择高效安全的椭圆曲线
# ============================================================================

# ---------------------------------------------------------------------------
# 椭圆曲线偏好设置
# ---------------------------------------------------------------------------
# 配置支持的椭圆曲线及其优先级
# X25519: 最现代、高效的椭圆曲线，提供最佳性能和安全性平衡
# secp256r1(Prime256v1): 广泛支持的标准曲线，兼容性好
# secp384r1: 提供更高安全性，但性能略低
# secp521r1: 最高安全级别，但性能影响较大
# 选择原理: 按性能和安全性平衡排序，X25519提供最佳平衡
# 注意: 此设置主要影响TLS 1.2，TLS 1.3有自己的曲线选择机制
ssl_ecdh_curve X25519:secp256r1:secp384r1:secp521r1;

# ============================================================================
# 五、SSL性能优化配置
# 优化SSL/TLS连接的性能
# ============================================================================

# ---------------------------------------------------------------------------
# SSL缓冲区大小设置
# ---------------------------------------------------------------------------
# 设置SSL记录缓冲区的大小
# 16k: 较大的缓冲区大小，优化大数据传输性能
# 工作原理: 控制每次SSL/TLS记录的大小
# 性能影响:
# - 较大的值(如16k)可以减少加密/解密操作次数，提高大文件传输性能
# - 较小的值(如4k)在高延迟环境中可能表现更好
# 最佳实践: 对于大多数网站，16k是良好的设置
ssl_buffer_size 16k;

# ============================================================================
# 六、OCSP Stapling配置 (当前已禁用)
# 优化证书验证过程，提高性能并保护隐私
# ============================================================================

# OCSP Stapling允许服务器在TLS握手时提供证书状态信息，无需客户端单独查询
# 优势:
# 1. 减少SSL握手时间，提高页面加载速度
# 2. 保护用户隐私，避免暴露用户正在访问的网站信息
# 3. 减轻证书颁发机构的OCSP服务器负载

# 要启用OCSP Stapling，请取消注释以下设置:
# ssl_stapling on;
# ssl_stapling_verify on;
# ssl_trusted_certificate /etc/ssl/certs/ca-certificates.crt;
# resolver 8.8.8.8 8.8.4.4 valid=300s;
# resolver_timeout 5s;

# 注意事项:
# - 确保证书中包含OCSP响应者URL
# - 配置可用的DNS解析器(resolver指令)
# - 提供可信证书链用于验证OCSP响应
# - 如果配置不当，可能导致握手失败或警告

# ============================================================================
# 七、HTTP安全响应头
# 通过HTTP头增强客户端安全
# ============================================================================

# ---------------------------------------------------------------------------
# HTTP严格传输安全(HSTS)
# ---------------------------------------------------------------------------
# 强制浏览器始终使用HTTPS连接
# 参数说明:
# - max-age=31536000: 设置缓存时间为一年(365天)
# - includeSubDomains: 此策略也应用于所有子域名
# - preload: 允许将域名加入浏览器的HSTS预加载列表
# 安全作用: 防止中间人攻击和协议降级攻击
# 重要注意事项:
# 1. 一旦设置且用户访问过，即使配置更改，浏览器仍会强制使用HTTPS
# 2. 确保所有子域名都能正确支持HTTPS，否则会导致访问问题
# 3. 移除HSTS需要等待max-age过期或用户清除浏览器缓存
add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

# ---------------------------------------------------------------------------
# MIME类型嗅探防护
# ---------------------------------------------------------------------------
# 防止浏览器对文件MIME类型进行嗅探
# 安全作用: 防止基于MIME类型混淆的XSS攻击
# 工作原理: 告知浏览器严格按照Content-Type头执行，不尝试猜测文件类型
# 最佳实践: 所有网站都应启用此设置
add_header X-Content-Type-Options "nosniff" always;

# ---------------------------------------------------------------------------
# XSS保护
# ---------------------------------------------------------------------------
# 启用浏览器内置的XSS过滤功能
# "1; mode=block": 启用XSS过滤，发现攻击时阻止页面加载而非仅过滤
# 安全作用: 提供额外的XSS防护层
# 兼容性: 主要作用于旧版浏览器，现代浏览器有更高级的保护机制
# 作为多层安全防护的一部分启用
add_header X-XSS-Protection "1; mode=block" always;

# ---------------------------------------------------------------------------
# 点击劫持防护 (当前已禁用)
# ---------------------------------------------------------------------------
# 防止站点被嵌入iframe中进行点击劫持攻击
# 已禁用以允许iframe嵌入，如需启用请取消注释:
# add_header X-Frame-Options "DENY" always;
# 可选值:
# - DENY: 不允许在任何框架中显示
# - SAMEORIGIN: 仅允许同源网站嵌入
# - ALLOW-FROM uri: 仅允许指定网站嵌入
# 注意: 如网站需要被嵌入iframe，请保持禁用此设置

# ---------------------------------------------------------------------------
# 内容安全策略(CSP) (当前已禁用)
# ---------------------------------------------------------------------------
# 限制可执行脚本和其他资源的来源，提供深度XSS防护
# 已禁用以与通用Nginx设置保持一致，如需启用请取消注释:
# add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:" always;
# 配置注意事项:
# 1. 需要根据网站实际需求调整策略，过于严格可能导致功能失效
# 2. 'unsafe-inline'通常应该避免，但为了兼容可能需要暂时保留
# 3. 建议在测试环境中启用并调试，确认无兼容性问题

# ============================================================================
# SSL配置最佳实践
# ============================================================================
# 1. 定期更新证书:
#    - SSL证书应定期更新(通常每3个月)
#    - 建议使用自动化工具如Certbot管理证书
#
# 2. 安全检查:
#    - 使用SSL Labs Test(https://www.ssllabs.com/ssltest/)定期测试配置
#    - 目标应达到A+评级
#    - 修复任何检测到的安全漏洞
#
# 3. 密钥管理:
#    - 确保私钥文件权限设置为600，仅允许root访问
#    - 考虑使用HSM(硬件安全模块)保护关键系统的私钥
#
# 4. 性能优化:
#    - 监控SSL握手时间和资源使用
#    - 对于高流量网站，考虑调整session_cache大小
#    - 启用HTTP/2以提高性能
#
# 5. 配置验证:
#    - 任何更改后使用nginx -t验证配置语法
#    - 检查错误日志中是否有SSL相关错误
#    - 在生产部署前进行全面测试
add_header Referrer-Policy "strict-origin-when-cross-origin" always;

# 添加Permissions-Policy响应头
# 限制浏览器API的使用，增强安全性
add_header Permissions-Policy "geolocation=(), camera=(), microphone=()" always;

# ============================================================
# TLS 1.2优化与兼容性说明
# ============================================================
# 此配置专门优化了对TLS 1.2的支持，包括：
# 1. 明确启用TLS 1.2协议
# 2. 提供全面兼容的安全加密套件
# 3. 优化椭圆曲线配置
# 4. 启用前向安全性保护
# 5. 配置会话缓存提高性能

# ============================================================
# 注意事项：
# 1. 请根据实际服务器性能和安全需求调整缓存大小和会话超时
# 2. 部分安全响应头可能需要根据应用兼容性进行调整
# 3. 确保SSL证书正确配置且未过期
# 4. 定期更新此配置以应对新出现的安全威胁
# 5. 此配置已针对TLS 1.2进行了优化，同时保留了TLS 1.3支持
# ============================================================
