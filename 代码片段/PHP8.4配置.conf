# ============================================================================
# php8.4配置文件
# 创建日期: 2025-11-08
# 最后修改: 2025-12-03
# 用途: 配置Nginx如何处理PHP文件请求，通过FastCGI与PHP-FPM交互
# 注意事项: 本配置已针对大文件上传(200MB)和长时间运行的PHP脚本进行了优化
# ============================================================================

# ============================================================================
# PHP文件请求处理location块
# 匹配所有以.php结尾的文件请求
# ============================================================================
location ~ \.php$ {
    # 显式声明默认类型，确保PHP文件不会被错误处理
    default_type application/octet-stream;
    
    # -----------------------------------------------------------------------
    # PHP-FPM连接配置
    # -----------------------------------------------------------------------
    # 通过Unix套接字连接到PHP-FPM服务
    # unix:/run/php/php8.4-fpm.sock: PHP 8.4 FPM服务的Unix套接字路径
    # 优点: 比TCP连接更高效，适用于Nginx和PHP-FPM在同一服务器上的情况
    # 替代选项: 若PHP-FPM在其他服务器，可使用 fastcgi_pass 127.0.0.1:9000;
    fastcgi_pass unix:/run/php/php8.4-fpm.sock;

    # -----------------------------------------------------------------------
    # 请求处理逻辑
    # -----------------------------------------------------------------------
    # 尝试访问请求的文件，若不存在则返回404错误
    # 防止路径遍历攻击和未找到文件的错误请求被传递给PHP处理器
    try_files $uri =404;

    # -----------------------------------------------------------------------
    # 超时设置 - 针对大文件处理和复杂操作进行了优化
    # -----------------------------------------------------------------------
    # PHP脚本执行超时时间
    # 1000秒: PHP脚本最多执行1000秒后Nginx将断开连接
    # 必须与PHP配置中的max_execution_time配合设置
    # 适用于: 大型数据库导入、复杂报表生成等耗时操作
    fastcgi_read_timeout 1000;
    
    # Nginx向PHP-FPM发送请求的超时时间
    # 1000秒: 发送请求超过此时间将断开连接
    fastcgi_send_timeout 1000;
    
    # 与PHP-FPM建立连接的超时时间
    # 1000秒: 连接建立超过此时间将断开
    fastcgi_connect_timeout 1000;

    # -----------------------------------------------------------------------
    # PHP文件索引和路径设置
    # -----------------------------------------------------------------------
    # 设置默认的PHP首页文件
    # 当请求目录时，会查找index.php文件
    fastcgi_index index.php;

    # 设置PHP脚本文件的完整路径
    # $document_root: 站点根目录
    # $fastcgi_script_name: 请求的PHP脚本名称
    # 此参数是必须的，PHP需要知道要执行的文件路径
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;

    # 设置PHP脚本名称参数
    # 提供被请求脚本的路径信息
    fastcgi_param SCRIPT_NAME $fastcgi_script_name;

    # -----------------------------------------------------------------------
    # 缓冲区优化设置 - 针对大文件和高负载进行了调优
    # -----------------------------------------------------------------------
    # 初始响应缓冲区大小
    # 512k: 设置较大的缓冲区以处理大型响应头和初始数据
    fastcgi_buffer_size 512k;
    
    # 响应缓冲区数量和大小
    # 500个缓冲区，每个64k: 总共约31MB的缓冲区空间
    # 足够处理大型PHP响应，减少临时文件写入
    fastcgi_buffers 500 64k;
    
    # 繁忙时允许使用的缓冲区大小
    # 1024k: 在高负载情况下允许使用的额外缓冲区大小
    # 通常设置为fastcgi_buffer_size的2倍
    fastcgi_busy_buffers_size 1024k;
    
    # 临时文件写入大小
    # 1024k: 当响应超过缓冲区大小时，写入临时文件的块大小
    # 较大的值适合大文件处理，但会增加内存使用
    fastcgi_temp_file_write_size 1024k;

    # -----------------------------------------------------------------------
    # 其他PHP参数包含
    # -----------------------------------------------------------------------
    # 包含标准的FastCGI参数配置
    # 提供了大量标准环境变量，如REMOTE_ADDR, SERVER_NAME等
    include fastcgi_params;

    # -----------------------------------------------------------------------
    # 请求体大小和超时设置 - 针对大文件上传进行了优化
    # -----------------------------------------------------------------------
    # 允许的最大请求体大小
    # 200M: 允许上传最大200MB的文件
    # 必须与PHP配置中的upload_max_filesize和post_max_size保持一致
    client_max_body_size 200M;

    # 客户端请求体数据传输超时时间
    # 300秒: 客户端上传数据必须在300秒内完成
    # 足够处理大文件在合理网速下的上传
    client_body_timeout 300;

    # -----------------------------------------------------------------------
    # 可选的额外优化参数
    # 取消注释以启用相应功能
    # -----------------------------------------------------------------------
    # 启用FastCGI缓存
    # fastcgi_cache php_cache;
    # fastcgi_cache_valid 200 304 1h;
    # fastcgi_cache_use_stale error timeout updating http_500 http_503;
    
    # 启用压缩输出
    # gzip on;
    # gzip_comp_level 6;
    # gzip_types text/html text/plain text/css application/javascript application/json;
}

# ============================================================================
# 配置说明和最佳实践
# 1. 超时设置(fastcgi_read_timeout等)应根据实际应用需求调整
# 2. 缓冲区大小应根据服务器内存和应用需求进行优化
# 3. client_max_body_size必须与PHP配置中的upload_max_filesize同步
# 4. 生产环境建议启用FastCGI缓存以提高性能
# 5. 配置修改后，建议使用phpinfo()验证PHP环境变量是否正确传递
# ============================================================================