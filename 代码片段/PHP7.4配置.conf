# 处理 PHP 文件的通用请求设置
# ============================================================================
# PHP7.4配置文件
# 创建日期: 2025-11-08
# 最后修改: 2025-11-08
# 用途: 为使用PHP7.4-FPM的站点提供FastCGI配置
# 适用范围: 需要处理PHP7.4脚本的Nginx服务块(server block)
# ============================================================================

# ============================================================================
# PHP文件请求处理location块
# 用于匹配并处理所有以.php结尾的请求
# ============================================================================
location ~ \.php$ {
    # 显式声明默认类型，确保PHP文件不会被错误处理
    default_type application/octet-stream;
    
    # ========================================================================
    # 1. PHP-FPM连接配置
    # ========================================================================
    # 指定PHP-FPM服务的监听地址
    # unix socket方式: 适用于PHP-FPM与Nginx在同一台服务器的情况
    # 优势: 比TCP连接更高效，减少网络栈开销
    # 注意: 确保socket文件权限正确，Nginx用户需有读取权限
    fastcgi_pass unix:/run/php/php7.4-fpm.sock;
    
    # ========================================================================
    # 2. 请求处理安全配置
    # ========================================================================
    # 若文件不存在则返回404错误
    # 工作原理: 如果请求的文件不存在，直接返回404错误
    # 安全考虑: 防止攻击者通过构造特殊URL执行服务器上的其他PHP文件
    # 重要性: 这是一个关键的安全措施，防止路径遍历攻击
    try_files $uri =404;
    
    # ========================================================================
    # 3. 超时设置
    # ========================================================================
    # FastCGI读取超时时间
    # 1000秒: 给予PHP脚本足够的执行时间，适合处理复杂操作
    # 配置意义: 防止PHP长时间执行导致连接被关闭
    # 风险: 过长可能导致资源耗尽，过短会中断正常的长时间操作
    fastcgi_read_timeout 1000;
    
    # FastCGI发送超时时间
    # 1000秒: 允许PHP脚本有足够的时间发送响应
    # 配置意义: 限制向FastCGI服务器发送请求的最大时间
    # 适用场景: 特别适用于处理大文件上传或大数据集处理
    fastcgi_send_timeout 1000;
    
    # FastCGI连接超时时间
    # 1000秒: 控制建立FastCGI连接的最大时间
    # 配置意义: 限制与FastCGI服务器建立连接的时间
    # 建议值: 通常设为与读取和发送超时相同的值
    fastcgi_connect_timeout 1000;

    # ========================================================================
    # 4. PHP处理参数配置
    # ========================================================================
    # 设置PHP首页文件
    # 工作原理: 当请求目录时，默认查找并执行index.php
    # 应用场景: 用于框架的路由系统和无扩展名URL
    fastcgi_index index.php;

    # 设置PHP脚本文件路径参数
    # 重要性: 告诉PHP-FPM要执行哪个文件，必须正确设置
    # 参数说明: $document_root是当前请求的根目录，$fastcgi_script_name是请求的PHP文件路径
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;

    # 设置PHP脚本名称参数
    # 用途: 提供给PHP脚本当前执行文件的路径信息
    # 应用场景: 某些应用程序需要此参数来确定当前脚本的位置
    fastcgi_param SCRIPT_NAME $fastcgi_script_name;

    # ========================================================================
    # 5. 缓冲区优化配置
    # ========================================================================
    # 主缓冲区大小
    # 512k: 设置较大的缓冲区以减少临时文件写入
    # 工作原理: 用于存储响应的第一部分(通常是HTTP头)
    # 性能影响: 较大的值可以减少I/O操作，但增加内存使用
    fastcgi_buffer_size 512k;
    
    # 缓冲区数量和大小
    # 500 64k: 500个缓冲区，每个64k，总共31.25MB
    # 工作原理: 存储响应体内容
    # 性能优化: 足够大的缓冲区可以避免将响应写入临时文件
    # 适用场景: 针对大文件处理进行了优化
    fastcgi_buffers 500 64k;
    
    # 忙碌缓冲区大小
    # 1024k: 单个连接同时发送到客户端的缓冲区大小
    # 工作原理: 控制向客户端同时发送的数据量
    # 建议设置: 通常设为单个fastcgi_buffer大小的2倍
    fastcgi_busy_buffers_size 1024k;
    
    # 临时文件写入大小
    # 1024k: 每次写入临时文件的数据块大小
    # 工作原理: 当响应超过buffer容量时使用临时文件
    # 性能影响: 较大的值减少写入次数，但增加单次I/O开销
    fastcgi_temp_file_write_size 1024k;

    # ========================================================================
    # 6. 其他FastCGI参数
    # ========================================================================
    # 包含默认的FastCGI参数
    # 这些参数定义在/etc/nginx/fastcgi_params文件中
    # 包含常用变量如REQUEST_METHOD, QUERY_STRING, CONTENT_TYPE等
    include fastcgi_params;

    # ========================================================================
    # 7. 请求体处理配置
    # ========================================================================
    # 客户端最大请求体大小
    # 200M: 允许上传最大200MB的文件或请求数据
    # 配置意义: 限制客户端可以发送的最大数据量
    # 注意事项: 需同时修改PHP配置中的upload_max_filesize和post_max_size
    client_max_body_size 200M;

    # 客户端请求体超时时间
    # 300秒: 给予客户端足够时间上传数据
    # 配置意义: 限制接收请求体的最大时间
    # 建议值: 与上传文件大小成正比
    client_body_timeout 300;
}

# ============================================================================
# 配置最佳实践说明
# ============================================================================
# 1. 性能优化:
#    - 根据服务器内存和并发连接数调整缓冲区大小
#    - 对于大文件上传，适当增加client_max_body_size和client_body_timeout
#    - 对于复杂计算，调整fastcgi_read_timeout以防止超时

# 2. 安全性考虑:
#    - 确保PHP-FPM配置中的cgi.fix_pathinfo=0
#    - 正确设置try_files指令防止路径遍历攻击
#    - 根据实际需求调整请求体大小限制，不要过大

# 3. PHP-FPM协调配置:
#    - 确保PHP-FPM的内存限制(memory_limit)足够
#    - 确保PHP的上传限制与Nginx一致
#    - 调整PHP-FPM的进程数以匹配Nginx的worker_processes

# 4. 监控建议:
#    - 监控PHP-FPM的慢日志以识别性能瓶颈
#    - 监控临时文件目录(/var/cache/nginx)的使用情况
#    - 检查错误日志中与FastCGI相关的错误