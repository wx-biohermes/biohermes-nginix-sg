# ============================================================================
# 静态文件缓存配置
# 创建日期: 2025-11-08
# 最后修改: 2025-11-08
# 用途: 优化静态资源的缓存和传输性能，确保浏览器高效利用缓存
# 适用范围: 所有网站静态文件请求(JavaScript、CSS、图片、字体等)
# 说明: 此文件通常包含在server块中，用于处理特定类型的静态文件请求
# ============================================================================

# 注意：通用配置如gzip、tcp_nodelay等已在通用Nginx设置.conf中定义
# 安全相关配置已在隐私保护设置.conf中定义

# ============================================================================
# 静态文件请求匹配
# ============================================================================
# 使用正则表达式匹配常见的静态文件类型
# 支持的文件类型包括:
# - JavaScript: .js
# - 样式表: .css
# - 图片: .jpg, .jpeg, .png, .gif, .svg, .webp
# - 图标: .ico
# - 字体文件: .woff, .woff2, .ttf, .eot
# 正则表达式解释:
# - ~: 启用正则表达式匹配模式(区分大小写)
# - .*\.: 匹配任意字符后跟一个点
# - (js|css|jpg|jpeg|png|gif|svg|webp|ico|woff|woff2|ttf|eot): 匹配括号中的任何文件扩展名
# - ?: 使末尾的问号可选(优化匹配性能)
# 增加更多现代静态文件类型支持，包括视频、音频和其他常见文件格式
# 优化正则表达式性能，使用非捕获组(?:)减少内存使用
location ~* \.(?:js|css|jpg|jpeg|png|gif|svg|webp|ico|woff2?|ttf|eot|mp[43]|webm|ogg|wav|flac|aac|pdf|docx?|xlsx?|pptx?|zip|rar|[7bg]z2?)$ {
    # ============================================================================
    # 客户端缓存控制
    # ============================================================================
    
    # ---------------------------------------------------------------------------
    # 设置静态文件缓存过期时间
    # ---------------------------------------------------------------------------
    # 设置浏览器缓存时间为365天
    # 技术原理: 向客户端发送Cache-Control和Expires响应头
    # 性能影响:
    # - 优势: 客户端可以长时间缓存文件，减少重复请求，显著提高页面加载速度
    # - 注意事项: 文件内容更新时，必须更改文件名(通常通过添加版本号或哈希值)确保客户端获取新文件
    # 适用场景: 适合不会频繁变化的静态资源
    # 替代选项: 对于可能变化的资源，可考虑使用较短的缓存时间，如7d或30d
    expires 365d;
    
    # ---------------------------------------------------------------------------
    # 缓存控制增强 - 忽略浏览器刷新
    # ---------------------------------------------------------------------------
    # 设置Cache-Control响应头，实现即使F5刷新也使用缓存的效果
    # 配置说明:
    # - public: 允许任何缓存(包括CDN、代理服务器等)缓存此响应
    # - max-age=31536000: 设置缓存有效时间为365天(以秒为单位)
    # - immutable: 告诉浏览器资源不会改变，即使刷新页面也直接使用缓存，不发送条件请求
    # 浏览器支持: 现代浏览器(Chrome 49+, Firefox 48+, Edge, Safari 13+)
    # 注意事项: 只有确定资源内容变更时会修改文件名的情况下才能使用immutable
    add_header Cache-Control "public, max-age=31536000, immutable" always;
    
    # ---------------------------------------------------------------------------
    # 额外缓存控制头
    # ---------------------------------------------------------------------------
    # Pragma响应头，兼容HTTP/1.0客户端
    # public在此处的作用是覆盖可能存在的Pragma: no-cache请求头
    # 这有助于确保即使客户端发送了Pragma: no-cache，服务器也明确指示可以缓存
    add_header Pragma "public" always;
    
    # 删除可能干扰缓存的头信息
    # 防止Last-Modified头导致的条件请求，与immutable配合使用效果更佳
    # 注意：如果需要支持部分内容请求(range requests)，可能需要保留Last-Modified
    # add_header Last-Modified "" always;
    
    # 对于带有版本号或哈希的URL，指示CDN和代理不要进行内容协商
    add_header Vary "Accept-Encoding" always;
    
    # ---------------------------------------------------------------------------
    # 资源提示 - 预连接和预加载
    # ---------------------------------------------------------------------------
    # 为关键第三方域名添加预连接提示，减少DNS查找和TLS握手时间
    # 可根据网站使用的第三方服务调整这些域名
    # add_header Link "<https://fonts.googleapis.com>; rel=preconnect; crossorigin" always;
    # add_header Link "<https://fonts.gstatic.com>; rel=preconnect; crossorigin" always;
    # add_header Link "<https://cdn.jsdelivr.net>; rel=preconnect; crossorigin" always;

    # ============================================================================
    # 服务端文件传输优化
    # ============================================================================
    
    # ---------------------------------------------------------------------------
    # 启用Sendfile机制
    # ---------------------------------------------------------------------------
    # 开启内核级文件传输优化
    # 技术原理:
    # - 传统方式: 磁盘 -> 内核缓冲区 -> 用户缓冲区 -> 内核套接字缓冲区 -> 网络
    # - Sendfile方式: 磁盘 -> 内核缓冲区 -> 内核套接字缓冲区 -> 网络
    # 性能提升: 减少了两次上下文切换和数据复制操作，显著提高大文件传输性能
    # 硬件要求: 要求底层操作系统支持sendfile系统调用(现代Linux/Unix系统均支持)
    # 注意事项: 不适用于需要在传输前修改文件内容的场景
    sendfile on;

    # ---------------------------------------------------------------------------
    # TCP优化 - 合并小包传输
    # ---------------------------------------------------------------------------
    # 启用TCP_NOPUSH标志(类Unix系统上为TCP_CORK)
    # 工作原理: 延迟发送小数据包，直到积累到一定大小再一次性发送
    # 与sendfile协同工作时:
    # - 允许Nginx在调用sendfile()时立即发送文件头和文件内容
    # - 避免TCP的Nagle算法与延迟确认之间的交互问题
    # 性能提升: 减少网络传输的数据包数量，降低网络开销和延迟
    # 最佳实践: 通常与sendfile一起启用，尤其适合静态文件传输
    tcp_nopush on;

    # ============================================================================
    # 日志和监控
    # ============================================================================
    
    # ---------------------------------------------------------------------------
    # 静态文件访问日志
    # ---------------------------------------------------------------------------
    # 单独记录静态文件的访问日志
    # 目的:
    # 1. 区分静态文件和动态请求的访问统计
    # 2. 便于分析静态资源的访问模式和性能
    # 3. 可以单独设置日志级别或格式
    # 日志路径: /var/log/nginx/static_files_access.log
    # 性能考虑: 对于高流量网站，考虑降低静态文件的日志详细程度或完全禁用
    access_log /var/log/nginx/static_files_access.log;

    # ============================================================================
    # 连接限制(可选配置)
    # ============================================================================
    
    # ---------------------------------------------------------------------------
    # 最大连接数限制
    # ---------------------------------------------------------------------------
    # 限制单个客户端对静态文件的并发连接数
    # 配置说明: 需要在http块中定义limit_conn_zone才能使用此指令
    # 例如: limit_conn_zone $binary_remote_addr zone=my_zone:10m;
    # 安全目的: 防止单个客户端消耗过多服务器资源，可能的DoS攻击
    # 性能平衡: 根据服务器性能和预期流量调整此值
    # 当前状态: 已注释，如需启用请取消注释并确保在http块中定义了相应的limit_conn_zone
    #limit_conn my_zone 1000;
    
    # ============================================================================
    # 性能优化配置
    # ============================================================================
    
    # ---------------------------------------------------------------------------
    # 内容压缩配置 - 已启用
    # ---------------------------------------------------------------------------
    # 注意：以下gzip配置已在通用Nginx设置.conf中定义，此处注释掉以避免重复
    #gzip on;
    #gzip_comp_level 5;
    #gzip_min_length 256;
    #gzip_proxied any;
    #gzip_vary on;
    #gzip_types
    #    text/plain
    #    text/css
    #    text/xml
    #    text/javascript
    #    application/javascript
    #    application/json
    #    application/xml
    #    application/xml+rss
    #    application/vnd.ms-fontobject
    #    font/ttf
    #    font/opentype
    #    font/x-woff
    #    image/svg+xml
    #    image/x-icon;
    
    # ---------------------------------------------------------------------------
    # 连接优化配置 - 已启用
    # ---------------------------------------------------------------------------
    # 注意：以下通用连接设置已在通用Nginx设置.conf中定义，此处注释掉以避免重复
    # keepalive连接设置，减少连接建立开销
    # keepalive_timeout 75;
    
    # 优化大文件传输的缓冲区大小
    # 这些参数通常在http块级别配置更为合理
    # client_body_buffer_size 128k;
    # client_max_body_size 20m;
    
    # 优化TCP连接参数
    # tcp_nodelay on;  # 对于小文件传输，减少延迟
    
    # 优化TCP拥塞控制算法
    # 启用BBR拥塞控制算法(需要内核支持)
    # tcp_congestion_control bbr;
    
    # 设置TCP窗口大小，优化大文件传输
    # tcp_window_scaling on;
    
    # ---------------------------------------------------------------------------
    # 文件系统缓存优化 - 已启用
    # ---------------------------------------------------------------------------
    # 启用Open File Cache，提高文件系统性能
    # max: 缓存的最大文件描述符数量
    # inactive: 文件在缓存中保持的非活动时间
    # valid: 检查缓存中文件信息有效性的时间间隔
    # min_uses: 一个文件在inactive时间内被访问的最小次数才会被缓存
    # errors: 是否缓存文件查找错误
    open_file_cache max=200000 inactive=20s;
    open_file_cache_valid 30s;
    open_file_cache_min_uses 2;
    open_file_cache_errors on;
    
    # ---------------------------------------------------------------------------
    # 缓存验证机制
    # ---------------------------------------------------------------------------
    # 为静态文件添加ETag支持
    # ETag提供了另一种资源验证机制，可与Last-Modified配合使用
    # 注意：对于使用内容哈希命名的静态文件，ETag的作用有限
    etag on;
    
    # ---------------------------------------------------------------------------
    # HTTP/2支持和优化
    # ---------------------------------------------------------------------------
    # 启用HTTP/2，减少连接开销和提高并行加载性能
    # 注意：需要在server块中启用http2
    # listen 443 ssl http2;
    
    # HTTP/2推送优化(可选)
    # 如果网站使用HTTP/2，可以推送关键资源
    # http2_push /css/main.css;
    # http2_push /js/main.js;
    # http2_push_preload on;
    
    # ---------------------------------------------------------------------------
    # 安全增强配置
    # ---------------------------------------------------------------------------
    # 注意：这些安全配置已在隐私保护设置.conf中定义，此处注释掉以避免重复
    # 禁用不必要的Server信息泄露
    # server_tokens off;
    
    # 添加X-Content-Type-Options头，防止MIME类型嗅探
    # add_header X-Content-Type-Options "nosniff" always;
    
    # 添加X-Frame-Options头，防止点击劫持攻击
    # add_header X-Frame-Options "SAMEORIGIN" always;
    
    # 添加Referrer-Policy头，控制Referer信息的发送
    # add_header Referrer-Policy "no-referrer-when-downgrade" always;
    
    # 可选：添加内容安全策略(CSP)
    # 根据具体网站调整策略
    # add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://trusted-cdn.com; style-src 'self' 'unsafe-inline' https://trusted-cdn.com; img-src 'self' data: https://trusted-cdn.com; font-src 'self' https://trusted-cdn.com; connect-src 'self' https://api.example.com" always;
    
    # ---------------------------------------------------------------------------
    # 预加载和预连接(可选)
    # ---------------------------------------------------------------------------
    # 对于关键资源，可以添加预加载提示
    # 注意：这应该根据具体网站的资源优先级进行调整
    # add_header Link "</css/main.css>; rel=preload; as=style" always;
    # add_header Link "</js/main.js>; rel=preload; as=script" always;
}

# ============================================================================
# 特定静态文件类型的高级配置
# ============================================================================

# ----------------------------------------------------------------------------
# 字体文件优化
# ----------------------------------------------------------------------------
# 字体文件通常体积较大，需要特别的缓存和压缩设置
# 使用不区分大小写的匹配模式提高兼容性
location ~* \.(?:woff2?|ttf|eot|otf)$ {
    # 设置更长的缓存时间，字体文件极少变更
    expires 365d;
    
    # 字体文件的特定缓存控制
    add_header Cache-Control "public, max-age=31536000, immutable" always;
    
    # 字体文件的CORS设置，允许跨域使用
    add_header Access-Control-Allow-Origin "*" always;
    
    # 启用压缩
    # 注意：基本gzip配置已在通用Nginx设置.conf中定义
    # 此处仅保留特定于字体的压缩级别覆盖
    # gzip on;  # 已在全局启用
    # gzip_comp_level 6;  # 覆盖全局级别
    
    # 不记录字体文件的访问日志，减少日志量
    access_log off;
}

# ----------------------------------------------------------------------------
# 图片文件优化
# ----------------------------------------------------------------------------
# 图片文件的特定配置
# 使用不区分大小写的匹配模式提高兼容性
location ~* \.(?:jpe?g|png|gif|webp|svg|ico)$ {
    # 图片缓存时间
    expires 365d;
    
    # 图片缓存控制
    add_header Cache-Control "public, max-age=31536000, immutable" always;
    
    # SVG文件可能需要CORS支持
    location ~.*\.svg$ {
        add_header Access-Control-Allow-Origin "*" always;
    }
    
    # 不记录图片访问日志，减少日志量
    access_log off;
}

# ----------------------------------------------------------------------------
# 媒体文件优化
# ----------------------------------------------------------------------------
# 视频和音频文件的特定配置
# 使用不区分大小写的匹配模式提高兼容性
location ~* \.(?:mp[43]|webm|ogg|wav|flac|aac)$ {
    # 媒体文件缓存时间
    expires 30d;
    
    # 媒体文件缓存控制
    add_header Cache-Control "public, max-age=2592000" always;
    
    # 启用范围请求支持，允许视频和音频的流式播放
    add_header Accept-Ranges bytes always;
    
    # 对于大型媒体文件，增加缓冲区大小
    client_body_buffer_size 256k;
    
    # 不记录媒体文件访问日志
    access_log off;
}

# ----------------------------------------------------------------------------
# WebP图片支持检测优化
# ----------------------------------------------------------------------------
# 当浏览器支持WebP格式时，尝试提供WebP版本的图片
# 使用try_files实现，避免嵌套if语句的问题
location ~* \.(?:jpe?g|png)$ {
    add_header Vary Accept always;
    
    # 检查浏览器是否支持WebP，如果支持则尝试提供WebP版本
    if ($http_accept ~* "image/webp") {
        set $webp_suffix ".webp";
    }
    
    # 尝试提供WebP版本，如果存在的话
    try_files $request_filename$webp_suffix $request_filename =404;
    
    # 根据文件扩展名设置内容类型
    if ($uri ~* \.webp$) {
        add_header Content-Type "image/webp" always;
    }
    if ($uri ~* \.jpe?g$) {
        add_header Content-Type "image/jpeg" always;
    }
    if ($uri ~* \.png$) {
        add_header Content-Type "image/png" always;
    }
}

# ----------------------------------------------------------------------------
# 错误处理优化
# ----------------------------------------------------------------------------
# 处理静态文件不存在的情况，避免不必要的错误日志
location ~* \.(?:js|css|jpe?g|png|gif|webp|svg|ico|woff2?|ttf|eot|otf|mp[43]|webm|ogg|wav|flac|aac)$ {
    try_files $uri =404;
    
    # 对于404响应，不记录详细错误信息
    error_log off;
}

# ----------------------------------------------------------------------------
# 高优先级资源处理
# ----------------------------------------------------------------------------
# 为关键JavaScript和CSS文件设置更高优先级的缓存策略
location ~* (?:main|bundle|app)\.(?:js|css)$ {
    expires 365d;
    add_header Cache-Control "public, max-age=31536000, immutable, stale-while-revalidate=86400" always;
    
    # 启用内容压缩
    # 注意：基本gzip配置已在通用Nginx设置.conf中定义
    # gzip on;  # 已在全局启用
    # gzip_comp_level 6;  # 覆盖全局级别
}

# ============================================================================
# 紧急清除缓存的处理方案
# ============================================================================
# 当需要紧急清除所有客户端缓存时，可以临时启用以下配置
# 使用方法：
# 1. 取消下面location块的注释
# 2. 在需要强制刷新缓存的URL上添加查询参数 ?nocache=1
# 3. 完成后重新注释此块
#
# location ~* \.(js|css|jpg|jpeg|png|gif|svg|webp|ico|woff|woff2|ttf|eot)(\?nocache=1)?$ {
#     # 设置短缓存时间
#     expires 1m;
#     
#     # 覆盖之前的Cache-Control设置
#     add_header Cache-Control "public, max-age=60" always;
#     
#     # 确保内容正确传递
#     try_files $uri =404;
# }

# ============================================================================
# 静态资源缓存最佳实践
# ============================================================================
# 1. 缓存策略:
#    - 长期缓存(365天): 适用于使用版本化文件名的静态资源
#    - 短期缓存(7-30天): 适用于可能在短期内更新的资源
#    - 无缓存: 适用于频繁变化的资源
#
# 2. 文件名版本控制:
#    - 推荐使用内容哈希作为文件名一部分(如style.d41d8cd98f.css)
#    - 或使用查询参数(如style.css?v=12345)，但注意某些CDN可能不会缓存带查询参数的URL
#
# 3. 监控与调优:
#    - 监控静态文件请求响应时间
#    - 分析缓存命中率
#    - 根据实际流量调整缓冲区大小和工作进程数
#
# 4. 安全考虑:
#    - 为敏感静态文件设置适当的访问控制
#    - 考虑为静态文件启用HTTPS
#    - 实现内容安全策略(CSP)限制资源加载来源
#
# 5. CDN集成:
#    - 考虑将静态资源部署到CDN，进一步提高访问速度
#    - 配置正确的缓存头以确保CDN有效缓存内容