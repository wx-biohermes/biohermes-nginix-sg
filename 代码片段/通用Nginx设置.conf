# ============================================================================
# 通用Nginx设置配置文件
# 创建日期: 2025-11-08
# 最后修改: 2025-11-08
# 用途: 包含全局HTTP级别的性能优化、安全性增强和稳定性提升配置
# 适用范围: 所有通过include引入此文件的Nginx配置
# ============================================================================

# ============================================================================
# 一、TCP连接优化配置
# 优化网络连接性能，减少延迟，提高吞吐量
# ============================================================================

# ---------------------------------------------------------------------------
# TCP_NODELAY - 禁用Nagle算法
# ---------------------------------------------------------------------------
# 禁用Nagle算法，立即发送小数据包
# 适用场景: 实时通信应用、API服务、聊天系统等对延迟敏感的应用
# 工作原理: 阻止TCP将小数据包合并等待，减少延迟但可能增加网络拥塞
# 性能影响: 提高响应速度，但可能略微增加网络流量
# 最佳实践: 对大多数Web应用建议启用，特别是有大量小请求的场景
tcp_nodelay on;

# ---------------------------------------------------------------------------
# TCP快速打开
# ---------------------------------------------------------------------------
# 启用TCP Fast Open，减少连接建立延迟
# 工作原理: 在SYN包中发送数据，节省一个RTT时间
# 系统要求: Linux内核3.7.1+，且Nginx编译时支持
# 性能提升: 对频繁的短连接可减少10-30%的连接建立时间
# 注意事项: 需同时在系统级别启用(sysctl -w net.ipv4.tcp_fastopen=3)
# tcp_fastopen on;

# ============================================================================
# 二、客户端连接超时配置
# 控制与客户端的连接生命周期，防止资源被长时间占用
# ============================================================================

# ---------------------------------------------------------------------------
# 客户端请求体超时
# ---------------------------------------------------------------------------
# 定义接收客户端请求体数据的最大超时时间
# 600秒: 给予足够时间上传较大文件，但又不会让连接无限期挂起
# 安全考虑: 过长可能导致DoS攻击（连接耗尽），过短会导致大文件上传失败
# 建议值: 普通网站30-60秒，文件上传服务300-1200秒
client_body_timeout 600s;

# ---------------------------------------------------------------------------
# 客户端请求头超时
# ---------------------------------------------------------------------------
# 定义接收客户端请求头的最大超时时间
# 600秒: 给慢速客户端足够时间发送请求头
# 安全考虑: 防止慢速客户端攻击(Slowloris)，恶意客户端可能用很长时间发送请求头
# 建议值: 普通网站10-60秒，特殊场景可适当延长
client_header_timeout 600s;

# ---------------------------------------------------------------------------
# Keepalive请求数限制
# ---------------------------------------------------------------------------
# 定义单个keepalive连接上允许的最大请求数
# 100: 每个持久连接最多处理100个请求后关闭
# 性能影响: 较高的值可以减少连接建立开销，但可能导致内存占用增加
# 安全考虑: 限制单个连接的请求数可以防止资源耗尽攻击
# 最佳实践: 根据请求频率和服务器内存调整，一般在50-1000之间
keepalive_requests 100;

# ---------------------------------------------------------------------------
# 客户端最大请求体大小
# ---------------------------------------------------------------------------
# 限制客户端请求体的最大大小，防止过大的请求消耗服务器资源
# 100m: 允许最大100MB的请求体
# 安全考虑: 防止DoS攻击，恶意客户端可能发送超大请求
# 注意事项: 站点特定的需求（如大文件上传）可在server块或location块中覆盖此值
# 建议值: 普通网站1-10MB，文件上传服务根据需要调整
client_max_body_size 100m;

# ============================================================================
# 三、缓冲区设置配置
# 优化内存使用，提高数据处理效率
# ============================================================================

# ---------------------------------------------------------------------------
# 客户端请求头缓冲区
# ---------------------------------------------------------------------------
# 设置用于存储客户端请求头的缓冲区大小
# 1k: 默认值，适合大多数请求头
# 性能影响: 过大浪费内存，过小可能导致请求头被写入临时文件
# 建议值: 1k-4k，大多数情况下1k已经足够
client_header_buffer_size 1k;

# ---------------------------------------------------------------------------
# 大客户端请求头缓冲区
# ---------------------------------------------------------------------------
# 设置用于存储超大请求头的缓冲区数量和大小
# 4 4k: 4个缓冲区，每个4k，总共16k
# 工作原理: 当请求头超过client_header_buffer_size时使用此缓冲区
# 适用场景: 包含大量Cookie或自定义头的请求
# 风险: 过大的值可能导致内存占用增加
large_client_header_buffers 4 4k;

# ---------------------------------------------------------------------------
# 客户端请求体缓冲区
# ---------------------------------------------------------------------------
# 设置用于存储客户端请求体的缓冲区大小
# 128k: 比默认值大，减少临时文件写入
# 工作原理: 请求体小于此值时保存在内存，超过则写入临时文件
# 性能影响: 较大的值减少I/O操作，但增加内存使用
# 建议值: 根据平均请求体大小调整，一般在16k-256k之间
client_body_buffer_size 128k;

# ============================================================================
# 四、安全性增强配置
# 减少信息泄露，防止常见Web攻击
# ============================================================================

# ---------------------------------------------------------------------------
# 隐藏服务器版本信息
# ---------------------------------------------------------------------------
# 禁用在错误页面和响应头中显示Nginx版本信息
# 安全考虑: 减少信息泄露，防止攻击者针对特定版本的漏洞进行攻击
# 最佳实践: 生产环境强烈建议启用
# 关闭服务器版本信息泄露，提高安全性
# 当设置为off时，Nginx将不会在响应头中显示版本号和操作系统信息
# 这可以减少潜在攻击者获取服务器信息的可能性
server_tokens off;

# ---------------------------------------------------------------------------
# 隐藏代理响应头信息
# ---------------------------------------------------------------------------
# 隐藏代理响应中的敏感头信息
# 安全考虑: 防止泄露后端技术栈信息，减少攻击面
# 作用范围: 仅对通过proxy_pass代理的请求生效
proxy_hide_header X-Powered-By;
proxy_hide_header Server;

# ---------------------------------------------------------------------------
# 更高级的响应头清理（需额外模块）
# ---------------------------------------------------------------------------
# 使用ngx_headers_more模块清理更多响应头
# 安装方法: apt install nginx-extras (Ubuntu/Debian)
# 功能: 比proxy_hide_header提供更强大的头信息控制能力
# more_clear_headers Server;  # 此指令需要安装 ngx_headers_more 模块

# ---------------------------------------------------------------------------
# MIME类型嗅探防护
# ---------------------------------------------------------------------------
# 防止浏览器对文件MIME类型进行嗅探
# 安全作用: 防止基于MIME类型混淆的XSS攻击
# 浏览器行为: 告知浏览器严格按照Content-Type头执行，不尝试猜测
# 最佳实践: 所有生产环境网站都应启用
add_header X-Content-Type-Options nosniff always;

# ---------------------------------------------------------------------------
# XSS保护
# ---------------------------------------------------------------------------
# 启用浏览器内置的XSS过滤器
# "1; mode=block": 启用XSS过滤，发现攻击时阻止页面加载而非仅过滤
# 兼容性: 主要作用于旧版浏览器，现代浏览器已默认有更高级保护
# 最佳实践: 作为多层安全防护的一部分启用
add_header X-XSS-Protection "1; mode=block" always;

# ---------------------------------------------------------------------------
# 内容安全策略(CSP) - 当前已禁用
# ---------------------------------------------------------------------------
# 内容安全策略是一个强大的安全机制，但配置复杂且可能影响网站功能
# 以下是一个适度宽松的配置示例，允许大多数常见的资源加载
# 建议: 在测试环境中启用并调试，确认无兼容性问题后再在生产环境启用
# add_header Content-Security-Policy "default-src 'self' https:; script-src 'self' 'unsafe-inline' https:; style-src 'self' 'unsafe-inline' https:; img-src 'self' data: https: blob:; font-src 'self' data: https:; connect-src 'self' https:; frame-src 'self' https:; frame-ancestors 'self';" always;

# ---------------------------------------------------------------------------
# 点击劫持防护 - 当前已禁用
# ---------------------------------------------------------------------------
# 防止站点被嵌入iframe中进行点击劫持攻击
# SAMEORIGIN: 仅允许同源网站嵌入此页面
# 注意: 若网站需要被其他站点嵌入iframe，请保持禁用
# add_header X-Frame-Options SAMEORIGIN always;

# ---------------------------------------------------------------------------
# HTTP严格传输安全(HSTS) - 当前已禁用
# ---------------------------------------------------------------------------
# 强制浏览器始终使用HTTPS访问网站
# max-age=31536000: 一年有效期
# includeSubDomains: 应用于所有子域名
# 注意: 仅在全站已配置HTTPS且无HTTP需求时启用
# add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

# ============================================================================
# 五、Gzip压缩配置
# 减少传输数据量，提高页面加载速度
# ============================================================================

# ---------------------------------------------------------------------------
# 启用Gzip压缩
# ---------------------------------------------------------------------------
# 开启响应内容的压缩功能
# 性能影响: 减少带宽使用，但增加CPU负载
# 最佳实践: 生产环境建议启用，特别是带宽有限的环境
gzip on;

# ---------------------------------------------------------------------------
# 压缩缓冲区配置
# ---------------------------------------------------------------------------
# 16 8k: 16个缓冲区，每个8k，总共128k的压缩缓冲区
# 工作原理: 压缩数据时使用的内存缓冲区大小
# 调优建议: 根据平均响应大小调整，一般设置为总大小128k-512k
gzip_buffers 16 8k;

# ---------------------------------------------------------------------------
# 压缩级别
# ---------------------------------------------------------------------------
# 压缩级别(1-9)，级别越高压缩率越大但CPU消耗也越多
# 6: 平衡压缩率和CPU消耗的折中值
# 性能影响:
# - 级别1-4: CPU消耗适中，压缩率逐渐提高
# - 级别5-6: 压缩率提升明显，但CPU消耗开始显著增加
# - 级别7-9: 压缩率边际收益很小，但CPU消耗大幅增加
# 最佳实践: 大多数网站推荐4-6之间的值
# 提示: 对于高流量网站，可以考虑降低压缩级别(如4)以减轻CPU负担
gzip_comp_level 6;

# ---------------------------------------------------------------------------
# 压缩最小文件大小
# ---------------------------------------------------------------------------
# 仅压缩大于指定大小的文件
# 1000字节: 小于1k的文件压缩效果有限，可能反而增加大小
# 最佳实践: 通常设置为1000-1500字节
# 计算公式: 压缩小文件的收益 = 网络传输节省 - 压缩/解压CPU开销
gzip_min_length 1000;

# ---------------------------------------------------------------------------
# 压缩HTTP版本
# ---------------------------------------------------------------------------
# 指定启用压缩的HTTP协议版本
# 1.1: 针对HTTP/1.1及以上版本启用压缩
# 历史背景: HTTP/1.0客户端可能不支持某些压缩特性
# 现代实践: 几乎所有现代浏览器都支持HTTP/1.1，此设置足够安全
gzip_http_version 1.1;

# ---------------------------------------------------------------------------
# 压缩文件类型
# ---------------------------------------------------------------------------
# 指定需要压缩的MIME类型
# 已包含常见的文本类型文件，如HTML、CSS、JavaScript、JSON、XML等
# 注意: 不要压缩二进制文件(图片、视频、音频等)，它们已经是压缩格式
# 建议: 根据网站实际使用的文件类型调整
gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

# ---------------------------------------------------------------------------
# 代理请求压缩
# ---------------------------------------------------------------------------
# 为通过代理传递的请求启用压缩
# any: 对所有代理请求启用压缩
# 替代选项: expired, no-cache, no-store, private, no_last_modified, no_etag
# 建议: 启用以优化后端服务响应
# 注意: 确保后端服务不会发送已压缩的内容
gzip_proxied any;

# ---------------------------------------------------------------------------
# 禁用特定浏览器的压缩
# ---------------------------------------------------------------------------
# 禁用IE6及以下版本的压缩，这些浏览器可能有兼容性问题
# "msie6": 使用正则表达式匹配IE6及以下版本的User-Agent
# 现代意义: 随着IE6使用率降低，此设置重要性下降，但保留无害
gzip_disable "msie6";

# ============================================================================
# 六、日志配置说明
# 访问日志和错误日志的格式和位置已在主配置文件nginx.conf中定义
# 如需自定义日志格式，请修改 /etc/nginx/代码片段/日志格式配置.conf
# ============================================================================

# ============================================================================
# 配置调优建议
# 1. 根据服务器资源和访问模式调整参数值
# 2. 定期监控服务器性能，分析日志，优化配置
# 3. 高流量站点可考虑进一步优化keepalive和缓冲区设置
# 4. 安全配置应根据具体业务需求进行调整，不要盲目复制
# 5. 配置修改后使用 nginx -t 检查语法正确性
# ============================================================================
# 如需自定义访问日志格式，请在nginx.conf的http块中进行配置

# ---------------------------- 文件传输优化 ----------------------------
# 启用 sendfile，加速文件传输，减少磁盘 I/O 和 CPU 开销
# sendfile on;  # 此指令已在nginx.conf中全局定义，避免重复

# 调整 sendfile_max_chunk 大小，防止单个 sendfile() 调用消耗过多资源
sendfile_max_chunk 1m;

# 启用 aio 异步 I/O，提高大文件处理性能
# aio on;  # 此指令在当前平台不支持

# 启用 directio，对于大文件跳过操作系统缓存，直接访问磁盘
directio 10m;

# ---------------------------- 代理设置优化 ----------------------------
# 设置代理缓冲区大小
proxy_buffer_size 4k;
proxy_buffers 4 32k;
proxy_busy_buffers_size 64k;

# 设置代理临时文件大小
proxy_temp_file_write_size 64k;

# 设置代理连接超时时间
proxy_connect_timeout 600s;
proxy_send_timeout 600s;
proxy_read_timeout 600s;

# 设置代理请求头中的 Host 字段
proxy_set_header Host $host;

# 设置代理请求头中的 X-Real-IP 字段
proxy_set_header X-Real-IP $remote_addr;

# 设置代理请求头中的 X-Forwarded-For 字段
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

# 设置代理请求头中的 X-Forwarded-Proto 字段
proxy_set_header X-Forwarded-Proto $scheme;

# 已安装 ngx_headers_more 模块，可使用 more_clear_headers 指令清除响应头
# 示例: more_clear_headers "Server" "X-Powered-By";
# 部分压缩和安全头配置被注释，可根据实际需求启用
