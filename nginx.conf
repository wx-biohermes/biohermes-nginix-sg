
# ============================================================================
# Nginx主配置文件 (nginx.conf)
# 创建日期: 2025-11-08
# 最后修改: 2025-11-08
# 注意事项: 升级Nginx时此文件可能会被覆盖，请尽量通过include方式使用自定义配置
# 推荐配置方式: 将具体配置放在代码片段/目录下，通过include引入
# ============================================================================

# ============================================================================
# 全局配置区域
# ============================================================================

# 指定Nginx工作进程运行的用户和用户组
# www-data: 系统默认的Web服务用户，具有适当的权限
user  www-data;

# 工作进程数量设置
# auto: 自动检测CPU核心数量并设置相应的工作进程数
# 最佳实践: 通常设置为CPU核心数或2倍核心数，根据实际负载调整
worker_processes  auto;

# 错误日志配置
# /var/log/nginx/error.log: 错误日志文件路径
# notice: 日志级别，记录notice及以上级别的错误(debug, info, notice, warn, error, crit)
# 生产环境建议使用warn或error级别减少日志量
error_log  /var/log/nginx/error.log notice;

# PID文件路径
# 存储Nginx主进程ID的文件，用于进程管理和监控
pid        /var/run/nginx.pid;

# ============================================================================
# events块 - 网络连接处理配置
# ============================================================================
events {
    # 每个工作进程的最大并发连接数
    # 1024: 每个worker进程最多同时处理1024个连接
    # 计算方式: 最大并发连接数 = worker_processes * worker_connections
    # 注意: 受系统ulimit限制，需要确保系统文件描述符限制足够高
    worker_connections  1024;
    
    # 可选配置: 连接处理方法
    # use epoll;  # Linux系统推荐使用epoll，性能更佳
    # use kqueue; # BSD系统推荐使用kqueue
    # use select; # 兼容性好但性能较低的方法
}

# ============================================================================
# http块 - HTTP服务器配置

http {
    # 引入日志格式配置
    include /etc/nginx/代码片段/日志格式配置.conf;
    # 包含HTTP协议相关的全局配置和默认值
    # ============================================================================
    # MIME类型配置
    # 引入预定义的MIME类型映射表
    include       /etc/nginx/mime.types;
    # 注意：default_type已移至PHP配置文件中，不再在此处全局设置

    # 日志配置
    # 注意：日志格式配置已在http块顶部引入
    
    # 定义404错误专用日志格式
    # 包含：访问IP、访问时间、请求URL、HTTP状态码、来源页面、用户代理
    log_format error_404 '$remote_addr - [$time_local] "$request" ' 
                        '$status "$http_referer" "$http_user_agent" ' 
                        '$request_time $http_x_forwarded_for';
    
    # 用于404错误日志过滤的map指令
    map $status $log404 {
        ~^404$ 1;
        default 0;
    }
    
    # 访问日志设置
    # /var/log/nginx/access.log: 访问日志文件路径
    # main: 使用的日志格式名称，在日志格式配置.conf中定义
    access_log  /var/log/nginx/access.log  main;

    # 性能优化设置
    # 启用零拷贝技术，提高文件传输性能
    sendfile        on;
    
    # 启用TCP_CORK选项，合并小数据包，减少网络传输次数
    # 与sendfile配合使用效果更佳，适用于静态文件服务
    # tcp_nopush     on;
    
    # 客户端连接保持时间
    # 65秒: 客户端连接建立后，无活动65秒后断开连接
    # 过长会占用服务器资源，过短会导致频繁建立连接
    keepalive_timeout  65;
    
    # 启用gzip压缩
    # 可以显著减少传输数据量，但会增加CPU负担
    # gzip  on;
    # 更多gzip配置建议在通用设置中定义
    
    # ============================================================================
    # 引入外部配置文件
    # ============================================================================
    
    # 引入通用Nginx设置，包含各种优化参数
    include /etc/nginx/代码片段/通用Nginx设置.conf;
    
    # 引入所有运行中的站点配置
    # 推荐将每个站点配置放在独立文件中，便于管理
    include /etc/nginx/运行站点/*;
    
    # 引入已启用的Nginx模块配置
    # 当前注释掉，表示不自动加载所有模块，而是在需要时单独配置
    #include /etc/nginx/modules-enabled/*.conf;
}

# ============================================================================
# 配置扩展说明
# 1. 如需添加stream模块配置(用于TCP/UDP代理)，请在http块外部添加
# 2. 站点特定配置应放在运行站点/目录下
# 3. 通用功能配置应放在代码片段/目录下
# 4. 配置修改后，请使用 nginx -t 检查语法，确认无误后重启或重载Nginx
# ============================================================================
