# PHP通用配置
# 此配置文件包含了处理PHP请求所需的通用FastCGI参数和安全设置

# 配置URI分割规则，用于处理PATH_INFO的情况
# 将请求URI分为两部分：PHP脚本文件名($fastcgi_script_name)和路径信息($fastcgi_path_info)
# 正则表达式说明：
# ^(.+?\.php) 匹配以.php结尾的部分作为脚本文件名
# (/.*)$ 匹配脚本文件名之后的所有路径信息
fastcgi_split_path_info ^(.+?\.php)(/.*)$;

# 安全检查：在传递请求前确保PHP脚本确实存在
# 如果请求的脚本不存在，则直接返回404错误，防止路径遍历攻击
try_files $fastcgi_script_name =404;

# 解决try_files重置$fastcgi_path_info的问题
# 这是Nginx的一个已知问题，需要通过变量赋值来保留路径信息
# 参考：http://trac.nginx.org/nginx/ticket/321
set $path_info $fastcgi_path_info;
fastcgi_param PATH_INFO $path_info;

# 设置默认的PHP索引文件为index.php
fastcgi_index index.php;

# 包含FastCGI基本配置文件
# 这些文件提供了处理PHP请求所需的标准参数
include fastcgi.conf;
include fastcgi_params;

# FastCGI连接超时设置
# 控制与FastCGI服务器建立连接的超时时间
fastcgi_connect_timeout 60s;

# FastCGI发送请求超时设置
# 控制向FastCGI服务器发送请求的超时时间
fastcgi_send_timeout 60s;

# FastCGI读取响应超时设置
# 控制等待FastCGI服务器响应的超时时间
fastcgi_read_timeout 60s;

# FastCGI缓冲区大小设置
# 设置用于读取FastCGI服务器响应头的缓冲区大小
fastcgi_buffer_size 64k;

# FastCGI缓冲区数量和大小设置
# 设置用于读取FastCGI服务器响应体的缓冲区数量和每个缓冲区的大小
fastcgi_buffers 4 64k;

# FastCGI繁忙缓冲区大小设置
# 当所有缓冲区都在使用时，限制单个连接可以使用的缓冲区大小
fastcgi_busy_buffers_size 128k;

# FastCGI临时文件写入大小设置
# 当响应超过缓冲区大小时，控制临时文件的写入大小
fastcgi_temp_file_write_size 128k;

# 安全增强：禁用FastCGI的PATH_INFO处理（防止某些PHP框架的安全问题）
# 仅在不需要PATH_INFO功能时启用此选项
# fastcgi_hide_header X-Powered-By;

# 安全增强：设置FastCGI响应头缓存控制
# 防止敏感信息被缓存
# add_header Cache-Control "no-cache, no-store, must-revalidate";
# add_header Pragma "no-cache";
# add_header Expires "0";

# 客户端请求体超时设置
# 控制读取客户端请求体的超时时间
client_body_timeout 60s;

# 客户端请求头超时设置
# 控制读取客户端请求头的超时时间
client_header_timeout 60s;

# 客户端最大请求体大小设置
# 限制客户端请求体的最大大小，防止过大的请求耗尽服务器资源
client_max_body_size 50M;